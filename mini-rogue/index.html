<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒŸãƒ‹ãƒ­ãƒ¼ã‚°+ï¼šå®ç®±ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ»3æŠ</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --text:#e8ecff; --muted:#a8b0d6;
      --accent:#66e3ff; --ok:#6dff9b; --bad:#ff6b8a; --warn:#ffd36d;
      --shadow:0 12px 30px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{
      margin:0; min-height:100vh; display:flex; justify-content:center; align-items:center;
      padding:16px; color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background: radial-gradient(1000px 700px at 20% 10%, #1b2a63 0%, transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, #1e5a5f 0%, transparent 55%),
                  var(--bg);
    }
    .app{
      width:min(640px,100%);
      background: rgba(18,26,51,.86);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    header{padding:18px 18px 10px; border-bottom:1px solid rgba(255,255,255,.08);}
    h1{margin:0 0 6px; font-size:18px;}
    .sub{margin:0; color:var(--muted); font-size:13px; line-height:1.4;}
    main{padding:16px 18px 18px;}
    .card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px;}
    .stats{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    .stat{background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px;}
    .label{color:var(--muted); font-size:12px;}
    .value{font-size:20px; font-weight:900; margin-top:4px;}
    .bar{height:10px; border-radius:999px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.06); overflow:hidden; margin-top:8px;}
    .bar > div{height:100%; width:50%; background:linear-gradient(90deg,var(--accent),#7cffc9); transition:width .2s;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900; border:1px solid rgba(255,255,255,.12); margin-right:6px;}
    .pill.ok{background:rgba(109,255,155,.14); border-color:rgba(109,255,155,.35);}
    .pill.bad{background:rgba(255,107,138,.14); border-color:rgba(255,107,138,.35);}
    .pill.neu{background:rgba(102,227,255,.12); border-color:rgba(102,227,255,.35);}
    .pill.warn{background:rgba(255,211,109,.12); border-color:rgba(255,211,109,.35);}
    .log{min-height:120px; line-height:1.65;}
    .log small{color:var(--muted);}
    .choices{display:grid; gap:10px; grid-template-columns:1fr; margin-top:12px;}
    button{
      border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06);
      color:var(--text); border-radius:16px; padding:14px 14px; font-weight:900; font-size:15px;
      text-align:left;
    }
    button:active{transform:translateY(1px);}
    .primary{background:rgba(102,227,255,.16); border-color:rgba(102,227,255,.35);}
    .okbtn{background:rgba(109,255,155,.12); border-color:rgba(109,255,155,.35);}
    .badbtn{background:rgba(255,107,138,.12); border-color:rgba(255,107,138,.35);}
    .warnbtn{background:rgba(255,211,109,.12); border-color:rgba(255,211,109,.35);}
    .muted{color:var(--muted);}
    .footer{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
    .footer button{flex:1 1 160px; text-align:center;}
    .list{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .tag{
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08);
    }
    /* ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã¯è² ã‘ãŸæ™‚ã ã‘è¡¨ç¤ºï¼ˆJSã§åˆ‡æ›¿ï¼‰ */
    #restart{ display:none; }
    /* ===== æˆ¦é—˜ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« ===== */
    .stage{
      margin-top:12px;
      position:relative;
      height:230px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(500px 200px at 30% 10%, rgba(102,227,255,.18), transparent 60%),
        radial-gradient(500px 220px at 80% 30%, rgba(109,255,155,.14), transparent 60%),
        rgba(0,0,0,.18);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding:12px;
    }
    
    .sprite{
      position:relative;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      width:48%;
      height:100%;
    }
    
    .sprite img{
      max-height:100%;
      max-width:100%;
      object-fit:contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
      transform-origin: bottom center;
    }
    
    /* è‡ªã‚­ãƒ£ãƒ©ã¯å°‘ã—å¯„ã›ã‚‹ */
    .sprite.player{ justify-content:flex-start; }
    .sprite.enemy{ justify-content:flex-end; }

    #enemyWrap{
      opacity:0;
      transform: translateX(12px);
      transition: opacity .2s ease, transform .2s ease;
    }
    #enemyWrap.hidden{
      opacity:0;
      pointer-events:none;
      transform: translateX(12px);
    }
    #enemyWrap:not(.hidden){
      opacity:1;
      transform: translateX(0);
    }
    
    /* ãƒœã‚¹æ„Ÿï¼šã¡ã‚‡ã„å¤§ããï¼‹ç™ºå…‰ */
    #enemyWrap.boss img{
      transform: scale(1.06);
      filter: drop-shadow(0 0 18px rgba(255,211,109,.25)) drop-shadow(0 10px 18px rgba(0,0,0,.45));
    }
    
    .stageHud{
      position:absolute;
      left:12px; right:12px; top:10px;
      display:flex;
      justify-content:flex-end;
      pointer-events:none;
    }
    .enemyName{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(232,236,255,.95);
    }
    
    /* ===== ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
    @keyframes lungePlayer{
      0%{ transform: translateX(0) scale(1); }
      45%{ transform: translateX(10px) scale(1.02); }
      100%{ transform: translateX(0) scale(1); }
    }
    @keyframes lungeEnemy{
      0%{ transform: translateX(0) scale(1); }
      45%{ transform: translateX(-10px) scale(1.02); }
      100%{ transform: translateX(0) scale(1); }
    }
    @keyframes hitFlash{
      0%{ filter: brightness(1) drop-shadow(0 10px 18px rgba(0,0,0,.45)); }
      30%{ filter: brightness(1.8) drop-shadow(0 0 14px rgba(255,107,138,.35)) drop-shadow(0 10px 18px rgba(0,0,0,.45)); }
      100%{ filter: brightness(1) drop-shadow(0 10px 18px rgba(0,0,0,.45)); }
    }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-3px); }
      50%{ transform: translateX(3px); }
      75%{ transform: translateX(-2px); }
      100%{ transform: translateX(0); }
    }
    @keyframes healGlow{
      0%{ filter: brightness(1) drop-shadow(0 10px 18px rgba(0,0,0,.45)); }
      35%{ filter: brightness(1.4) drop-shadow(0 0 18px rgba(109,255,155,.35)) drop-shadow(0 10px 18px rgba(0,0,0,.45)); }
      100%{ filter: brightness(1) drop-shadow(0 10px 18px rgba(0,0,0,.45)); }
    }
    
    #playerWrap.attack img{ animation: lungePlayer .22s ease-out 1; }
    #enemyWrap.attack img{ animation: lungeEnemy .22s ease-out 1; }
    
    #playerWrap.hurt img, #enemyWrap.hurt img{ animation: hitFlash .26s ease-out 1; }
    #playerWrap.shake, #enemyWrap.shake{ animation: shake .28s ease-out 1; }
    #playerWrap.heal img{ animation: healGlow .35s ease-out 1; }
    
    @media (prefers-reduced-motion: reduce){
      #playerWrap.attack img, #enemyWrap.attack img,
      #playerWrap.hurt img, #enemyWrap.hurt img,
      #playerWrap.shake, #enemyWrap.shake,
      #playerWrap.heal img{
        animation: none !important;
      }
    }
    .pickRow{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .pickThumb{
      width:64px;
      height:64px;
      border-radius:14px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .pickThumb img{
      width:100%;
      height:100%;
      object-fit:contain;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>ãƒŸãƒ‹ãƒ­ãƒ¼ã‚°+ï¼ˆå®ç®±ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ»3æŠï¼‰</h1>
    <p class="sub">å„éšã§<b>3ã¤ã®æ‰‰</b>ã‚’é¸ã‚“ã§é€²ã‚€ã€‚<b>4éš/8éšã¯ãƒœã‚¹</b>ï¼ˆå¼·æ•µï¼‹ç¢ºå®šãƒ¬ãƒªãƒƒã‚¯ï¼‰ã€‚<b>8éšçªç ´</b>ã§å‹åˆ©ï¼</p>
  </header>
  <main>
    <section class="card">
      <div class="stats">
        <div class="stat">
          <div class="label">ã‚ãªãŸ</div>
          <div class="value"><span id="hp">20</span>/<span id="maxhp">20</span> HP</div>
          <div class="bar"><div id="hpbar"></div></div>
          <div class="muted" style="margin-top:8px;font-size:12px;">é˜²å¾¡: <b id="block">0</b> / ã‚³ã‚¤ãƒ³: <b id="gold">0</b></div>
        </div>
        <div class="stat">
          <div class="label">æ•µ</div>
          <div class="value"><span id="ehp">-</span>/<span id="emaxhp">-</span> HP</div>
          <div class="bar"><div id="ehpbar"></div></div>
          <div class="muted" style="margin-top:8px;font-size:12px;">äºˆå®šæ”»æ’ƒ: <b id="eintent">-</b></div>
        </div>
        <div class="stat">
          <div class="label">é€²è¡Œ</div>
          <div class="value">éšå±¤ <span id="floor">1</span> / <span id="goal">8</span></div>
          <div class="muted" style="margin-top:8px;font-size:12px;">å‹åˆ©æ•°: <b id="wins">0</b></div>
        </div>
      </div>
      <div class="list" id="relics"></div>
      <!-- â–¼ æˆ¦é—˜ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆã‚­ãƒ£ãƒ©è¡¨ç¤ºï¼‰ -->
      <div class="stage" id="stage">
        <div class="sprite player" id="playerWrap">
          <img id="playerImg" src="./assets/player.png" alt="Player">
        </div>
      
        <div class="sprite enemy" id="enemyWrap" aria-hidden="true">
          <img id="enemyImg" src="./assets/enemy.png" alt="Enemy">
        </div>
      
        <div class="stageHud">
          <div class="enemyName" id="enemyName"></div>
        </div>
      </div>
      <!-- â–² æˆ¦é—˜ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« -->
    </section>

    <!-- â–¼ ã‚­ãƒ£ãƒ©é¸æŠï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹å‰ï¼‰ -->
    <div class="card" id="pickCard" style="margin-top:12px; display:none;">
      <div class="log">
        <span class="pill neu">ã‚­ãƒ£ãƒ©é¸æŠ</span>
        æœ€åˆã«ä½¿ã†ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
      </div>
      <div class="choices" id="pickChoices"></div>
    </div>
    <!-- â–² ã‚­ãƒ£ãƒ©é¸æŠ -->

    <section class="card" style="margin-top:12px;">
      <div class="log" id="log"></div>
      <div class="choices" id="choices"></div>
      <div class="footer">
        <button id="restart" class="primary">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="share">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </section>
  </main>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const GOAL = 8;
  const BOSS_FLOORS = new Set([4, 8]);
  // --- ã‚­ãƒ£ãƒ©æ¼”å‡ºç”¨ ---
  const playerWrap = $("playerWrap");
  const enemyWrap  = $("enemyWrap");
  const enemyNameEl = $("enemyName");

  // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€™è£œ ---
  const PLAYERS = [
    { id:"p1", name:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1", src:"./assets/player.png" },
    { id:"p2", name:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2", src:"./assets/player2.png" },
  ];

  function showPlayerPick(){
    $("choices").innerHTML = "";
    
    S.mode = "pick";
    ui();
  
    $("pickCard").style.display = "block";
  
    const wrap = $("pickChoices");
    wrap.innerHTML = "";
  
    PLAYERS.forEach(p=>{
      const b = document.createElement("button");
      b.className = "primary";
      b.innerHTML = `
        <div class="pickRow">
          <div class="pickThumb"><img src="${p.src}" alt=""></div>
          <div>
            <b>${p.name}</b><br>
            <span class="muted">ã“ã®ã‚­ãƒ£ãƒ©ã§å†’é™ºã™ã‚‹</span>
          </div>
        </div>
      `;
      b.addEventListener("click", ()=>{
        $("pickCard").style.display = "none";
        setPlayerById(p.id);
        screenChooseRoom(); // ã‚²ãƒ¼ãƒ é–‹å§‹
      });
      wrap.appendChild(b);
    });
  
    // ãƒ­ã‚°å´ã®ãƒœã‚¿ãƒ³ï¼ˆæˆ¦é—˜ãªã©ï¼‰ã‚’ä¸€æ—¦æ¶ˆã™
    setChoices([]);
    log(`<span class="pill neu">ã‚­ãƒ£ãƒ©é¸æŠ</span>å†’é™ºè€…ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`);
  }

  function setPlayerById(id){
    const p = PLAYERS.find(x=>x.id===id) || PLAYERS[0];
    S.playerId = p.id;
    S.playerSrc = p.src;
  
    const img = $("playerImg");
    img.src = p.src;
    if(p.id==="p1"){
      S.maxhp = 24; S.hp = 24;
    }else if(p.id==="p2"){
      S.gold += 15;
    }
    ui();
  }
  
  // ã‚¢ãƒ‹ãƒ¡ã‚’ç¢ºå®Ÿã«å†ç”Ÿã™ã‚‹ãŸã‚ã€classã‚’ä»˜ã‘ç›´ã™
  function playAnim(el, cls, ms=350){
    el.classList.remove(cls);
    void el.offsetWidth; // reflow
    el.classList.add(cls);
    setTimeout(()=>el.classList.remove(cls), ms);
  }
  
  function setEnemyVisible(visible){
    if(visible) enemyWrap.classList.remove("hidden");
    else enemyWrap.classList.add("hidden");
  }
  // -------------- ä¾¿åˆ©é–¢æ•° --------------
  const r = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const clamp = (v,a,b)=>Math.max(a, Math.min(b, v));
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  const chance = (p)=>Math.random()<p;

  const isBossFloor = (floor)=>BOSS_FLOORS.has(floor);

  // -------------- ãƒ¬ãƒªãƒƒã‚¯å®šç¾© --------------
  const RELICS = [
    { id:"spike", name:"ãƒˆã‚²ã®æŒ‡è¼ª", desc:"æ”»æ’ƒ+1ï¼ˆæ¯å›ï¼‰", onAtk:(s, dmg)=>dmg+1 },
    { id:"bandage", name:"åŒ…å¸¯", desc:"æˆ¦é—˜å‹åˆ©ã§HP+2", onWin:(s)=>{ s.hp = clamp(s.hp+2, 0, s.maxhp); } },
    { id:"coin", name:"å¹¸é‹ã®ã‚³ã‚¤ãƒ³", desc:"å®ç®±/ã‚¤ãƒ™ãƒ³ãƒˆã§+8ã‚³ã‚¤ãƒ³", onGainGold:(s, amt, src)=> (src!=="combat") ? amt+8 : amt },
    { id:"shield", name:"å¤ã„ç›¾", desc:"é˜²å¾¡ã‚’å¾—ã‚‹é‡+2", onBlock:(s, b)=>b+2 },
    { id:"blood", name:"è¡€ã®å¥‘ç´„", desc:"å›å¾©é‡+2ã€æœ€å¤§HP-2", onPick:(s)=>{ s.maxhp=Math.max(8, s.maxhp-2); s.hp=clamp(s.hp,0,s.maxhp); }, onHeal:(s, h)=>h+2 },
    { id:"rage", name:"æ€’ã‚Šã®ä»®é¢", desc:"HP50%ä»¥ä¸‹ã®æ™‚ æ”»æ’ƒ+3", onAtk:(s, dmg)=> (s.hp <= Math.floor(s.maxhp/2)) ? dmg+3 : dmg },
    { id:"mender", name:"å°ã•ãªä¿®ç†å…·", desc:"ä¼‘æ†©ã§ã•ã‚‰ã«HP+3", onRest:(s, heal)=>heal+3 },
    { id:"gambler", name:"ã‚®ãƒ£ãƒ³ãƒ–ãƒ©ãƒ¼", desc:"è³­ã‘æˆåŠŸç‡+15%", onGambleChance:(s, p)=>Math.min(0.95, p+0.15) },
    { id:"thief", name:"ç›—è³Šã®æ‰‹è¢‹", desc:"æˆ¦é—˜å‹åˆ©ã‚³ã‚¤ãƒ³+5", onGainGold:(s, amt, src)=> (src==="combat") ? amt+5 : amt },
  ];

  // -------------- çŠ¶æ…‹ --------------
  const S = {
    floor: 1,
    maxhp: 20,
    hp: 20,
    block: 0,
    gold: 0,
    wins: 0,
    relics: [],
    mode: "chooseRoom",
    enemy: null,
    enemyIntent: 0,
    turns: 0,
    last: "",
    tempStartBlock: 0,
    over: false,
    won: false,
    playerId: null,
    playerSrc: "./assets/player.png",
  };

  // -------------- åŠ¹æœé©ç”¨ --------------
  function applyRelicsHook(hookName, ...args){
    let out = args[0];
    for(const id of S.relics){
      const rel = RELICS.find(x=>x.id===id);
      const fn = rel && rel[hookName];
      if(typeof fn === "function"){
        const res = fn(S, out, ...args.slice(1));
        if(res !== undefined) out = res;
      }
    }
    return out;
  }

  // -------------- UI --------------
  function ui(){
    $("hp").textContent = S.hp;
    $("maxhp").textContent = S.maxhp;
    $("block").textContent = S.block;
    $("gold").textContent = S.gold;
    $("floor").textContent = S.floor;
    $("goal").textContent = GOAL;
    $("wins").textContent = S.wins;

    $("hpbar").style.width = `${(S.hp/S.maxhp)*100}%`;

    if(S.enemy){
      $("ehp").textContent = S.enemy.hp;
      $("emaxhp").textContent = S.enemy.maxhp;
      $("ehpbar").style.width = `${(S.enemy.hp/S.enemy.maxhp)*100}%`;
      $("eintent").textContent = S.enemyIntent;
      enemyNameEl.textContent = S.enemy.name || "";
      setEnemyVisible(true);
      // ãƒœã‚¹ãªã‚‰è¦‹ãŸç›®å¼·åŒ–
      enemyWrap.classList.toggle("boss", !!S.enemy.boss);
    }else{
      $("ehp").textContent = "-";
      $("emaxhp").textContent = "-";
      $("ehpbar").style.width = "0%";
      $("eintent").textContent = "-";
      enemyNameEl.textContent = "";
      setEnemyVisible(false);
      enemyWrap.classList.remove("boss");
    }

    // ãƒ¬ãƒªãƒƒã‚¯è¡¨ç¤º
    const wrap = $("relics");
    wrap.innerHTML = "";
    if(S.relics.length===0){
      const t = document.createElement("div");
      t.className = "tag";
      t.textContent = "ãƒ¬ãƒªãƒƒã‚¯ï¼šãªã—";
      wrap.appendChild(t);
    }else{
      for(const id of S.relics){
        const rel = RELICS.find(x=>x.id===id);
        const t = document.createElement("div");
        t.className = "tag";
        t.textContent = `${rel.name}`;
        wrap.appendChild(t);
      }
    }

    // âœ… ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã¯ã€Œè² ã‘ãŸæ™‚ã ã‘ã€è¡¨ç¤º
    $("restart").style.display = (S.mode === "gameover") ? "inline-block" : "none";

    if(S.mode === "pick"){
      setEnemyVisible(false);
    }
  }

  function log(html){ $("log").innerHTML = html; }
  function setChoices(arr){
    const wrap = $("choices");
    wrap.innerHTML = "";
    arr.forEach(c=>{
      const b = document.createElement("button");
      b.className = c.cls || "";
      b.innerHTML = c.label;
      b.disabled = !!c.disabled;
      b.addEventListener("click", c.onClick);
      wrap.appendChild(b);
    });
  }

  // -------------- ãƒ«ãƒ¼ãƒ ç”Ÿæˆ --------------
  const ROOM_TYPES = ["combat","combat","combat","treasure","event","rest","shop"];
  const ROOM_LABEL = {
    combat: { icon:"âš”ï¸", name:"æˆ¦é—˜" },
    treasure:{ icon:"ğŸ§°", name:"å®ç®±" },
    event:  { icon:"â“", name:"ã‚¤ãƒ™ãƒ³ãƒˆ" },
    rest:   { icon:"ğŸ›ï¸", name:"ä¼‘æ†©" },
    shop:   { icon:"ğŸ›’", name:"å•†äºº" },
  };

  function nextRooms(){
    const pool = ROOM_TYPES.slice();
    if(S.floor <= 2){
      pool.push("rest","shop");
    }
    if(S.floor >= GOAL-2){
      pool.push("combat","combat");
    }
    const rooms = [];
    while(rooms.length<3){
      const t = pick(pool);
      if(rooms.filter(x=>x===t).length>=2) continue;
      rooms.push(t);
    }
    return rooms;
  }

  // -------------- æ•µ --------------
  function enemyForFloor(f){
    const base = 9 + f*3;
    return {
      name: pick(["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚´ãƒ–ãƒªãƒ³","ã‚³ãƒœãƒ«ãƒˆ","å½±ã®ç£","é§ã®äº¡éœŠ"]),
      maxhp: base,
      hp: base,
      atkMin: 2 + f,
      atkMax: 4 + f*2,
      boss: false
    };
  }

  function bossEnemyForFloor(f){
    // ãƒœã‚¹ã¯ã€Œç¡¬ã„ï¼‹ç—›ã„ã€ï¼‹å°‘ã—æ´¾æ‰‹
    const base = 18 + f*5;     // 4F: 38 / 8F: 58
    const atkMin = 6 + f;      // 4F:10 / 8F:14
    const atkMax = 10 + f*2;   // 4F:18 / 8F:26
    return {
      name: (f===8) ? "æ·±å±¤ã®ç‹" : "é–€ç•ªã®å·¨ç£",
      maxhp: base,
      hp: base,
      atkMin,
      atkMax,
      boss: true
    };
  }

  function rollEnemyIntent(){
    S.enemyIntent = r(S.enemy.atkMin, S.enemy.atkMax);
  }

  // -------------- ç”»é¢ï¼šéƒ¨å±‹é¸æŠ --------------
  function screenChooseRoom(){
    // âœ… ãƒœã‚¹éšã¯éƒ¨å±‹é¸æŠãªã—ã§ãƒœã‚¹æˆ¦ã¸
    if(isBossFloor(S.floor)){
      return screenCombatStart(true);
    }

    S.mode = "chooseRoom";
    S.block = 0;
    S.enemy = null;
    ui();

    const rooms = nextRooms();
    log(`<span class="pill neu">éšå±¤${S.floor}</span>æ‰‰ãŒ3ã¤ã‚ã‚‹ã€‚ã©ã‚Œã«é€²ã‚€ï¼Ÿ<br><small>â€» 4éš/8éšã¯ãƒœã‚¹æˆ¦ï¼ˆç¢ºå®šãƒ¬ãƒªãƒƒã‚¯ï¼‰</small>`);

    setChoices(rooms.map(t=>{
      const info = ROOM_LABEL[t];
      const desc = (t==="combat") ? "æ•µã¨æˆ¦ã†ï¼ˆå‹ã¦ã°å ±é…¬ï¼‰"
                 : (t==="treasure") ? "ãƒ¬ãƒªãƒƒã‚¯3æŠï¼ˆ1ã¤å…¥æ‰‹ï¼‰"
                 : (t==="event") ? "ä¸€ç™ºé€†è»¢orå¤§äº‹æ•…"
                 : (t==="rest") ? "HPå›å¾©ï¼ˆæˆ¦é—˜ãªã—ï¼‰"
                 : "ã‚³ã‚¤ãƒ³ã§å¼·åŒ–ï¼ˆæˆ¦é—˜ãªã—ï¼‰";
      const cls = (t==="combat") ? "primary"
               : (t==="treasure") ? "warnbtn"
               : (t==="event") ? "badbtn"
               : (t==="rest") ? "okbtn"
               : "okbtn";
      return {
        label:`${info.icon} <b>${info.name}</b> <span class="muted">â€” ${desc}</span>`,
        cls,
        onClick: ()=> enterRoom(t)
      };
    }));
  }

  function enterRoom(t){
    if(t==="combat") return screenCombatStart(false);
    if(t==="treasure") return screenTreasure();
    if(t==="event") return screenEvent();
    if(t==="rest") return screenRest();
    if(t==="shop") return screenShop();
  }

  // -------------- æˆ¦é—˜ --------------
  function screenCombatStart(isBoss){
    S.mode = "combat";
    S.block = 0;
    S.enemy = isBoss ? bossEnemyForFloor(S.floor) : enemyForFloor(S.floor);

    // å•†äººã§è²·ã£ãŸã€Œé–‹å§‹æ™‚é˜²å¾¡ã€åæ˜ 
    if(S.tempStartBlock){
      S.block += S.tempStartBlock;
      S.tempStartBlock = 0;
    }

    rollEnemyIntent();
    ui();

    const bossTxt = isBoss ? ` <span class="pill warn">BOSS</span>` : "";
    log(`<span class="pill neu">æˆ¦é—˜</span>${bossTxt}${S.enemy.name}ãŒç¾ã‚ŒãŸï¼<br><small>æ•µã®æ¬¡ã®æ”»æ’ƒã¯ <b>${S.enemyIntent}</b></small>`);
    setChoices(makeCombatChoices());
  }

  function makeCombatChoices(){
    const atkMin = 4 + Math.floor(S.floor/2);
    const atkMax = 7 + Math.floor(S.floor/2);

    const doAttack = () => {
      let dmg = r(atkMin, atkMax);
      playAnim(playerWrap, "attack");
      playAnim(enemyWrap, "hurt");
      // ã€Œä¼‘æ†©ï¼šç ”ãã€ä¸€æ™‚ãƒãƒ•ï¼ˆæ¬¡ã®æ”»æ’ƒã ã‘+4ï¼‰
      if(S.tempSharpen){
        dmg += 4;
        S.tempSharpen = false;
      }

      dmg = applyRelicsHook("onAtk", dmg);
      S.enemy.hp = clamp(S.enemy.hp - dmg, 0, S.enemy.maxhp);
      S.last = `ã‚ãªãŸã®æ”»æ’ƒï¼ æ•µã« <b>${dmg}</b> ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚`;
      afterPlayerAction();
    };

    const doGuard = () => {
      let b = r(5, 8) + S.floor;
      b = applyRelicsHook("onBlock", b);
      S.block = b;
      S.last = `é˜²å¾¡ï¼ æ¬¡ã®è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ <b>${b}</b> è»½æ¸›ã€‚`;
      afterPlayerAction();
    };

    const doHeal = () => {
      let h = r(4, 7);
      h = applyRelicsHook("onHeal", h);
      S.hp = clamp(S.hp + h, 0, S.maxhp);
      S.last = `å›å¾©ï¼ HPã‚’ <b>${h}</b> å›å¾©ã€‚`;
      afterPlayerAction();
    };

    const baseP = 0.55;
    const p = applyRelicsHook("onGambleChance", baseP);

    const doGamble = () => {
      const hit = chance(p);
      const dmg = hit ? r(10, 16) + Math.floor(S.floor/2) : 0;
      const self = hit ? 0 : r(2, 5);
      S.enemy.hp = clamp(S.enemy.hp - dmg, 0, S.enemy.maxhp);
      S.hp = clamp(S.hp - self, 0, S.maxhp);
      S.last = hit
        ? `ğŸ² è³­ã‘æˆåŠŸï¼ <b>${dmg}</b> ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`
        : `ğŸ² è³­ã‘å¤±æ•—â€¦ è‡ªåˆ†ã« <b>${self}</b> ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚`;
      afterPlayerAction();
    };

    const list = [
      { label:`âš”ï¸ æ”»æ’ƒ <span class="muted">(${atkMin}ã€œ${atkMax})</span>`, cls:"primary", onClick: doAttack },
      { label:`ğŸ›¡ï¸ é˜²å¾¡ <span class="muted">(è»½æ¸› 5ã€œ${8+S.floor}+åŠ¹æœ)</span>`, cls:"okbtn", onClick: doGuard },
      { label:`ğŸ’š å›å¾© <span class="muted">(4ã€œ7+åŠ¹æœ)</span>`, cls:"okbtn", onClick: doHeal },
    ];

    if(chance(0.35)){
      const idx = r(0,2);
      list[idx] = { label:`ğŸ² è³­ã‘ <span class="muted">(æˆåŠŸ${Math.round(p*100)}% / å¤±æ•—ã§è‡ªå‚·)</span>`, cls:"badbtn", onClick: doGamble };
    }
    return list;
  }

  function afterPlayerAction(){
    S.turns++;

    if(S.enemy.hp <= 0){
      S.wins++;

      // å ±é…¬ï¼šã‚³ã‚¤ãƒ³
      let gold = r(8, 14) + S.floor + (S.enemy.boss ? 10 : 0);
      gold = applyRelicsHook("onGainGold", gold, "combat");
      S.gold += gold;

      applyRelicsHook("onWin", 0);
      ui();

      // âœ… ãƒœã‚¹å‹åˆ©ãªã‚‰ã€Œç¢ºå®šãƒ¬ãƒªãƒƒã‚¯ã€ã¸
      if(S.enemy.boss){
        log(`<span class="pill ok">BOSSæ’ƒç ´</span>${S.last}<br>å ±é…¬ï¼š<b>+${gold}</b>ã‚³ã‚¤ãƒ³<br><small>ãƒœã‚¹å ±é…¬ï¼šç¢ºå®šãƒ¬ãƒªãƒƒã‚¯</small>`);
        return screenBossReward(() => {
          if(S.floor >= GOAL){
            return screenVictory();
          }
          S.floor++;
          return screenChooseRoom();
        });
      }

      // é€šå¸¸å‹åˆ©
      if(S.floor >= GOAL){
        return screenVictory();
      }
      S.floor++;
      log(`<span class="pill ok">æ’ƒç ´</span>${S.last}<br>å ±é…¬ï¼š<b>+${gold}</b>ã‚³ã‚¤ãƒ³<br><small>æ¬¡ã®éšå±¤ã¸é€²ã‚€â€¦</small>`);
      setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
      return;
    }

    enemyTurn();
  }

  function enemyTurn(){
    playAnim(enemyWrap, "attack");
    playAnim(playerWrap, "hurt");
    const atk = S.enemyIntent;
    const reduced = Math.min(S.block, atk);
    const dmg = atk - reduced;
    S.block = 0;
    S.hp = clamp(S.hp - dmg, 0, S.maxhp);

    rollEnemyIntent();
    ui();

    if(S.hp <= 0){
      return screenGameOver(atk, reduced, dmg);
    }

    log(`${S.last}<br>æ•µã®æ”»æ’ƒ ${atk}ï¼ˆè»½æ¸› ${reduced}ï¼‰â†’ è¢«ãƒ€ãƒ¡ ${dmg}<br><small>æ•µã®æ¬¡ã®æ”»æ’ƒã¯ <b>${S.enemyIntent}</b></small>`);
    setChoices(makeCombatChoices());
  }

  // -------------- âœ… ãƒœã‚¹å ±é…¬ï¼ˆç¢ºå®šãƒ¬ãƒªãƒƒã‚¯ï¼‰ --------------
  function screenBossReward(onDone){
    S.mode = "bossReward";
    ui();

    const candidates = RELICS.filter(x=>!S.relics.includes(x.id));
    const picks = [];
    while(picks.length < 3 && candidates.length>0){
      const rel = candidates.splice(r(0, candidates.length-1), 1)[0];
      picks.push(rel);
    }

    log(`<span class="pill warn">ãƒœã‚¹å ±é…¬</span>ãƒ¬ãƒªãƒƒã‚¯ã‚’1ã¤é¸ã¹ã‚‹ã€‚`);

    setChoices(picks.map(rel=>({
      label:`ğŸ† <b>${rel.name}</b><br><span class="muted">${rel.desc}</span>`,
      cls:"warnbtn",
      onClick: ()=>{
        S.relics.push(rel.id);
        if(typeof rel.onPick === "function") rel.onPick(S);
        ui();
        log(`<span class="pill warn">å…¥æ‰‹</span><b>${rel.name}</b> ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼<br><small>${rel.desc}</small>`);
        setChoices([{label:"é€²ã‚€", cls:"primary", onClick: onDone}]);
      }
    })));
  }

  // -------------- å®ç®±ï¼ˆãƒ¬ãƒªãƒƒã‚¯3æŠï¼‰ --------------
  function screenTreasure(){
    S.mode = "treasure";
    ui();

    const candidates = RELICS.filter(x=>!S.relics.includes(x.id));
    const picks = [];
    while(picks.length < 3 && candidates.length>0){
      const rel = candidates.splice(r(0, candidates.length-1), 1)[0];
      picks.push(rel);
    }

    let g = r(6, 10);
    g = applyRelicsHook("onGainGold", g, "treasure");
    S.gold += g;

    log(`<span class="pill warn">å®ç®±</span>å®ç®±ã‚’è¦‹ã¤ã‘ãŸï¼ <b>+${g}</b>ã‚³ã‚¤ãƒ³<br><small>ãƒ¬ãƒªãƒƒã‚¯ã‚’1ã¤é¸ã¹ã‚‹ã€‚</small>`);

    setChoices(picks.map(rel=>({
      label:`ğŸ§° <b>${rel.name}</b><br><span class="muted">${rel.desc}</span>`,
      cls:"warnbtn",
      onClick: ()=>{
        S.relics.push(rel.id);
        if(typeof rel.onPick === "function") rel.onPick(S);
        ui();
        log(`<span class="pill warn">å…¥æ‰‹</span><b>${rel.name}</b> ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼<br><small>${rel.desc}</small>`);
        setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
      }
    })));
  }

  // -------------- ã‚¤ãƒ™ãƒ³ãƒˆ --------------
  function screenEvent(){
    S.mode = "event";
    ui();

    const ev = pick(["fountain","altar","stranger","trap"]);
    if(ev==="fountain"){
      log(`<span class="pill bad">ã‚¤ãƒ™ãƒ³ãƒˆ</span>æ€ªã—ã„æ³‰ãŒã‚ã‚‹â€¦ã©ã†ã™ã‚‹ï¼Ÿ`);
      setChoices([
        { label:`ğŸ’§ é£²ã‚€ <span class="muted">ï¼ˆå›å¾© or æ¯’ï¼‰</span>`, cls:"badbtn", onClick: ()=>{
          if(chance(0.55)){
            let h = r(7, 12);
            h = applyRelicsHook("onHeal", h);
            S.hp = clamp(S.hp + h, 0, S.maxhp);
            S.last = `æ³‰ã¯ç™’ã‚„ã—ã ã£ãŸï¼ HP+${h}`;
          }else{
            const d = r(5, 9);
            S.hp = clamp(S.hp - d, 0, S.maxhp);
            S.last = `æ¯’ã ã£ãŸâ€¦ HP-${d}`;
          }
          ui();
          if(S.hp<=0) return defeatFromEvent();
          log(`<span class="pill bad">çµæœ</span>${S.last}`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }},
        { label:`ğŸš¶ ç«‹ã¡å»ã‚‹ <span class="muted">ï¼ˆå®‰å…¨ï¼‰</span>`, cls:"okbtn", onClick: ()=>{
          log(`<span class="pill neu">å›é¿</span>ä½•ã‚‚ã—ãªã„ã®ãŒä¸€ç•ªã€‚`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }},
      ]);
      return;
    }

    if(ev==="altar"){
      log(`<span class="pill bad">ã‚¤ãƒ™ãƒ³ãƒˆ</span>å¤ã„ç¥­å£‡ãŒã‚ã‚‹ã€‚ã€Œæ§ã’ã‚ˆã€ã¨æ›¸ã„ã¦ã‚ã‚‹â€¦`);
      setChoices([
        { label:`ğŸ©¸ HPã‚’æ§ã’ã‚‹ <span class="muted">ï¼ˆæœ€å¤§HP+2 & ã‚³ã‚¤ãƒ³+10ï¼‰</span>`, cls:"badbtn", onClick: ()=>{
          const d = r(3,6);
          S.hp = clamp(S.hp - d, 0, S.maxhp);
          S.maxhp += 2;
          let g = 10;
          g = applyRelicsHook("onGainGold", g, "event");
          S.gold += g;
          S.last = `HP-${d}ã€æœ€å¤§HP+2ã€ã‚³ã‚¤ãƒ³+${g}`;
          ui();
          if(S.hp<=0) return defeatFromEvent();
          log(`<span class="pill bad">çµæœ</span>${S.last}`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }},
        { label:`ğŸª™ ã‚³ã‚¤ãƒ³ã‚’æ§ã’ã‚‹ <span class="muted">ï¼ˆãƒ¬ãƒªãƒƒã‚¯3æŠï¼‰</span>`, cls:"warnbtn", onClick: ()=>{
          const cost = 12;
          if(S.gold < cost){
            log(`<span class="pill warn">ä¸è¶³</span>ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šãªã„ï¼ˆå¿…è¦${cost} / æ‰€æŒ${S.gold}ï¼‰ã€‚`);
            setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
            return;
          }
          S.gold -= cost;
          ui();
          screenTreasure();
        }},
        { label:`ğŸš¶ ç«‹ã¡å»ã‚‹`, cls:"okbtn", onClick: ()=>{
          log(`<span class="pill.neu">å›é¿</span>é¢å€’ã«ã¯é–¢ã‚ã‚‰ãªã„ã€‚`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }},
      ]);
      return;
    }

    if(ev==="stranger"){
      log(`<span class="pill bad">ã‚¤ãƒ™ãƒ³ãƒˆ</span>è¬ã®è¡Œå•†äººãŒè¿‘ã¥ã„ã¦ãã‚‹â€¦ã€Œå‹è² ã—ãªã„ã‹ï¼Ÿã€`);
      setChoices([
        { label:`ğŸ² ã‚³ã‚¤ãƒ³10ã§å‹è²  <span class="muted">ï¼ˆå‹ã¦ã°+25 / è² ã‘ã§0ï¼‰</span>`, cls:"badbtn", onClick: ()=>{
          const bet = 10;
          if(S.gold < bet){
            log(`<span class="pill warn">ä¸è¶³</span>ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šãªã„ï¼ˆå¿…è¦${bet}ï¼‰ã€‚`);
            setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
            return;
          }
          S.gold -= bet;
          const win = chance(0.45);
          let gain = 0;
          if(win){
            gain = 25;
            gain = applyRelicsHook("onGainGold", gain, "event");
            S.gold += gain;
            S.last = `å‹ã£ãŸï¼ +${gain}ã‚³ã‚¤ãƒ³`;
          }else{
            S.last = `è² ã‘ãŸâ€¦ ä½•ã‚‚å¾—ã‚‰ã‚Œãªã„`;
          }
          ui();
          log(`<span class="pill bad">çµæœ</span>${S.last}`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }},
        { label:`ğŸ’š äº¤æ› <span class="muted">ï¼ˆHP+6 ãŸã ã—ã‚³ã‚¤ãƒ³-8ï¼‰</span>`, cls:"okbtn", onClick: ()=>{
          const cost = 8;
          if(S.gold < cost){
            log(`<span class="pill warn">ä¸è¶³</span>ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šãªã„ï¼ˆå¿…è¦${cost}ï¼‰ã€‚`);
            setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
            return;
          }
          S.gold -= cost;
          let h = 6;
          h = applyRelicsHook("onHeal", h);
          S.hp = clamp(S.hp + h, 0, S.maxhp);
          ui();
          log(`<span class="pill ok">çµæœ</span>HP+${h} / ã‚³ã‚¤ãƒ³-${cost}`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }},
        { label:`ğŸš¶ ç«‹ã¡å»ã‚‹`, cls:"okbtn", onClick: ()=>{
          log(`<span class="pill neu">å›é¿</span>é–¢ã‚ã‚‰ãªã„ã€‚`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }},
      ]);
      return;
    }

    // trap
    log(`<span class="pill bad">ã‚¤ãƒ™ãƒ³ãƒˆ</span>åºŠãŒæ€ªã—ã„â€¦ç½ ã‹ã‚‚ã—ã‚Œãªã„ã€‚ã©ã†å‹•ãï¼Ÿ`);
    setChoices([
      { label:`ğŸ§  æ…é‡ã«é€²ã‚€ <span class="muted">ï¼ˆè¢«å®³å° / æ™‚ã€…ã‚³ã‚¤ãƒ³ï¼‰</span>`, cls:"okbtn", onClick: ()=>{
        if(chance(0.35)){
          let g = r(6, 12);
          g = applyRelicsHook("onGainGold", g, "event");
          S.gold += g;
          S.last = `ç½ ã‚’å›é¿ã—ã¤ã¤æ‹¾ã„ç‰©ï¼ +${g}ã‚³ã‚¤ãƒ³`;
        }else{
          const d = r(2, 5);
          S.hp = clamp(S.hp - d, 0, S.maxhp);
          S.last = `å°‘ã—å¼•ã£ã‹ã‹ã£ãŸâ€¦ HP-${d}`;
        }
        ui();
        if(S.hp<=0) return defeatFromEvent();
        log(`<span class="pill bad">çµæœ</span>${S.last}`);
        setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
      }},
      { label:`ğŸƒ èµ°ã‚ŠæŠœã‘ã‚‹ <span class="muted">ï¼ˆæˆåŠŸã§å®ç®± / å¤±æ•—ã§å¤§ãƒ€ãƒ¡ï¼‰</span>`, cls:"badbtn", onClick: ()=>{
        if(chance(0.45)){
          S.last = `æˆåŠŸï¼ èµ°ã‚ŠæŠœã‘ãŸå…ˆã«å®ç®±ï¼`;
          ui();
          log(`<span class="pill warn">æˆåŠŸ</span>${S.last}`);
          setChoices([{label:"å®ç®±ã‚’é–‹ã‘ã‚‹", cls:"warnbtn", onClick: screenTreasure}]);
        }else{
          const d = r(6, 10);
          S.hp = clamp(S.hp - d, 0, S.maxhp);
          ui();
          if(S.hp<=0) return defeatFromEvent();
          log(`<span class="pill bad">å¤±æ•—</span>å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸â€¦ HP-${d}`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }
      }},
    ]);
  }

  function defeatFromEvent(){
    S.mode = "gameover";
    ui();
    log(`<span class="pill bad">æ•—åŒ—</span>ã‚¤ãƒ™ãƒ³ãƒˆã®çµæœã§å€’ã‚ŒãŸâ€¦<br><small>åˆ°é”ï¼šéšå±¤${S.floor}/${GOAL} / å‹åˆ©æ•°:${S.wins} / æ‰‹æ•°:${S.turns}</small>`);
    setChoices([]); // è² ã‘ãŸã‚‰ä¸‹ã®ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§å†é–‹
  }

  // -------------- ä¼‘æ†© --------------
  function screenRest(){
    S.mode = "rest";
    ui();

    const baseHeal = r(6, 10);
    let heal = applyRelicsHook("onRest", baseHeal);
    log(`<span class="pill ok">ä¼‘æ†©</span>å®‰å…¨åœ°å¸¯ã ã€‚ã©ã†ã™ã‚‹ï¼Ÿ`);

    setChoices([
      { label:`ğŸ›ï¸ ä¼‘ã‚€ <span class="muted">(HP+${heal})</span>`, cls:"okbtn", onClick: ()=>{
        S.hp = clamp(S.hp + heal, 0, S.maxhp);
        ui();
        log(`<span class="pill ok">å›å¾©</span>HP+${heal}`);
        setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
      }},
      { label:`ğŸ”§ ç ”ã <span class="muted">(æ¬¡ã®æˆ¦é—˜ã®æœ€åˆã®æ”»æ’ƒ+4)</span>`, cls:"primary", onClick: ()=>{
        S.tempSharpen = true;
        ui();
        log(`<span class="pill neu">æº–å‚™</span>æ­¦å™¨ã‚’ç ”ã„ã ã€‚æ¬¡ã®æˆ¦é—˜ã®æœ€åˆã®æ”»æ’ƒãŒå¼·åŒ–ã•ã‚Œã‚‹ã€‚`);
        setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
      }},
    ]);
  }

  // -------------- å•†äºº --------------
  function screenShop(){
    S.mode = "shop";
    ui();

    const items = [
      { name:"å°å›å¾©", desc:"HP+8", cost: 10, buy: ()=>{
        let h=8; h = applyRelicsHook("onHeal", h);
        S.hp = clamp(S.hp + h, 0, S.maxhp);
      }},
      { name:"æœ€å¤§HPå¼·åŒ–", desc:"æœ€å¤§HP+3ï¼ˆHP+3ï¼‰", cost: 16, buy: ()=>{
        S.maxhp += 3;
        S.hp = clamp(S.hp + 3, 0, S.maxhp);
      }},
      { name:"é‰„å£", desc:"æ¬¡ã®æˆ¦é—˜é–‹å§‹æ™‚ é˜²å¾¡+10", cost: 12, buy: ()=>{
        S.tempStartBlock = (S.tempStartBlock || 0) + 10;
      }},
    ];

    log(`<span class="pill ok">å•†äºº</span>ã‚³ã‚¤ãƒ³ã§å¼·åŒ–ã§ãã‚‹ã€‚<br><small>æ‰€æŒã‚³ã‚¤ãƒ³ï¼š<b>${S.gold}</b></small>`);

    setChoices([
      ...items.map(it=>({
        label:`ğŸ›’ <b>${it.name}</b> <span class="muted">ï¼ˆ${it.cost}ã‚³ã‚¤ãƒ³ï¼‰</span><br><span class="muted">${it.desc}</span>`,
        cls:"okbtn",
        disabled: S.gold < it.cost,
        onClick: ()=>{
          if(S.gold < it.cost) return;
          S.gold -= it.cost;
          it.buy();
          ui();
          log(`<span class="pill ok">è³¼å…¥</span>${it.name} ã‚’è³¼å…¥ã—ãŸã€‚`);
          setChoices([{label:"é€²ã‚€", cls:"primary", onClick: screenChooseRoom}]);
        }
      })),
      { label:`ğŸš¶ ä½•ã‚‚è²·ã‚ãšã«é€²ã‚€`, cls:"primary", onClick: screenChooseRoom }
    ]);
  }

  // -------------- å‹åˆ©/æ•—åŒ— --------------
  function screenVictory(){
    S.mode = "victory";
    ui();
    log(`<span class="pill ok">å‹åˆ©</span><b>8éšå±¤ã‚’çªç ´ã—ãŸï¼</b><br><small>å‹åˆ©æ•°:${S.wins} / æ‰‹æ•°:${S.turns} / ãƒ¬ãƒªãƒƒã‚¯:${S.relics.length}</small>`);
    setChoices([{label:"ã‚‚ã†ä¸€å›", cls:"primary", onClick:start}]);
  }

  function screenGameOver(atk, reduced, dmg){
    S.mode = "gameover";
    ui();
    log(`<span class="pill bad">æ•—åŒ—</span>${S.last}<br>æ•µã®æ”»æ’ƒ ${atk}ï¼ˆè»½æ¸› ${reduced}ï¼‰â†’ è¢«ãƒ€ãƒ¡ ${dmg}<br><b>HPãŒ0ã«ãªã£ãŸâ€¦</b><br><small>åˆ°é”ï¼šéšå±¤${S.floor}/${GOAL} / å‹åˆ©æ•°:${S.wins} / æ‰‹æ•°:${S.turns}</small>`);
    setChoices([]); // âœ… è² ã‘ãŸã‚‰ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§å†é–‹
  }

  // -------------- å…±æœ‰/å†èµ·å‹• --------------
  function start(){
    S.floor = 1;
    S.maxhp = 20;
    S.hp = 20;
    S.block = 0;
    S.gold = 0;
    S.wins = 0;
    S.relics = [];
    S.enemy = null;
    S.enemyIntent = 0;
    S.turns = 0;
    S.last = "";
    S.tempSharpen = false;
    S.tempStartBlock = 0;
    S.mode = "chooseRoom";
    ui();
    showPlayerPick();
  }

  $("restart").addEventListener("click", start);
  $("share").addEventListener("click", async ()=>{
    const text =
      `ãƒŸãƒ‹ãƒ­ãƒ¼ã‚°+ï¼šéšå±¤${S.floor}/${GOAL} å‹åˆ©æ•°${S.wins} HP${S.hp}/${S.maxhp} ã‚³ã‚¤ãƒ³${S.gold} ãƒ¬ãƒªãƒƒã‚¯${S.relics.length}`;
    try{
      await navigator.clipboard.writeText(text);
      alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n" + text);
    }catch(e){
      prompt("ã“ã‚Œã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã­", text);
    }
  });

  start();
})();
</script>
</body>
</html>
